# Find payee with maximum number of different payers and analyze their top payers
print("üèÜ PAYEE WITH MOST DIVERSE PAYER BASE - Top 10 Payers Analysis")
print("=" * 60)

# Step 1: Find the payee with most unique different payers
payee_unique_payers = original_data.groupby('payee_Company_Name')['payer_Company_Name'].nunique().sort_values(ascending=False)
top_diverse_payee = payee_unique_payers.index[0]
unique_payers_count = payee_unique_payers.iloc[0]

print(f"üéØ PAYEE #1: {top_diverse_payee}")
print("=" * 60)

# Step 2: Get all transactions for this payee
top_payee_data = original_data[original_data['payee_Company_Name'] == top_diverse_payee].copy()

# Ensure ed_amount is numeric
top_payee_data['ed_amount'] = pd.to_numeric(top_payee_data['ed_amount'], errors='coerce').fillna(0)

# Total transactions for this payee
total_transactions = len(top_payee_data)
total_amount = top_payee_data['ed_amount'].sum()

print(f"\nüìä PAYERS TO {top_diverse_payee}:")
print(f"Total Transactions Received: {total_transactions} (Original)")
print(f"Total Amount Received: ${total_amount:,.0f} (Original)")
print(f"Number of Different Payers: {unique_payers_count}")

# Step 3: Analyze each payer to this payee
payer_analysis = top_payee_data.groupby('payer_Company_Name').agg({
    'ed_amount': ['count', 'sum', 'mean']
}).round(2)

# Flatten column names
payer_analysis.columns = ['Orig_Count', 'Orig_Amount', 'Orig_Avg']
payer_analysis = payer_analysis.reset_index()

# Sort by transaction count (descending)
payer_analysis = payer_analysis.sort_values('Orig_Count', ascending=False)

# Format the detailed analysis table
detailed_analysis = []
for idx, row in payer_analysis.iterrows():
    payer_name = row['payer_Company_Name']
    orig_count = int(row['Orig_Count'])
    orig_amount = row['Orig_Amount']
    orig_avg = row['Orig_Avg']
    
    # Truncate long company names
    display_name = payer_name[:25] + '...' if len(payer_name) > 25 else payer_name
    
    detailed_analysis.append({
        'Payer': display_name,
        'Orig_Count': orig_count,
        'Orig_Amount': f"${orig_amount:,.0f}",
        'Orig_Avg': f"${orig_avg:,.0f}"
    })

# Convert to DataFrame for display
detailed_df = pd.DataFrame(detailed_analysis)

# Add row numbers starting from 0
detailed_df.reset_index(drop=True, inplace=True)

print(f"\nüí∞ DETAILED PAYER-TO-PAYEE ANALYSIS:")
display(detailed_df)

# Add totals row
total_count = payer_analysis['Orig_Count'].sum()
total_amount_calc = payer_analysis['Orig_Amount'].sum()
total_avg = total_amount_calc / total_count if total_count > 0 else 0

print(f"\nüìã TOTALS:")
print(f"Total Transactions: {total_count:,}")
print(f"Total Amount: ${total_amount_calc:,.0f}")
print(f"Average Transaction: ${total_avg:,.0f}")

# Show top 10 summary
print(f"\nüîù TOP 10 PAYERS SUMMARY:")
top_10_summary = detailed_df.head(10).copy()
top_10_summary.index = top_10_summary.index + 1  # Start numbering from 1

display(top_10_summary)

print(f"\n‚úÖ COMPANY-LEVEL CROSS-TABULATION SUMMARY")
print("=" * 50)
print(f"Analyzed payee: {top_diverse_payee}")
print(f"Total unique payers: {unique_payers_count}")
print(f"Criterion: Payee with maximum number of different payers")
print(f"Showing detailed breakdown of top 10 payer relationships")
